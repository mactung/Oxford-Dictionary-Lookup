import{A as m}from"./config.js";const h="randomPracticeCheck",u=1;function g(){chrome.alarms.create(h,{periodInMinutes:u}),console.log("Random Practice: Alarm created/updated with period",u)}chrome.runtime.onInstalled.addListener(()=>{g()});chrome.runtime.onStartup.addListener(()=>{g()});chrome.tabs.onUpdated.addListener((r,t,e)=>{t.status==="complete"&&s(r)});chrome.alarms.onAlarm.addListener(r=>{r.name===h&&s()});function s(r=null){chrome.storage.local.get(["randomPracticeEnabled","randomPracticeFrequency","randomPracticeLastTime","randomPracticeSnoozeUntil","vocabulary"],t=>{const{randomPracticeEnabled:e,randomPracticeFrequency:c=60,randomPracticeLastTime:n=0,randomPracticeSnoozeUntil:i=0,vocabulary:a=[]}=t;if(console.log("Random Practice Check:",{enabled:e,vocabLength:a.length,lastTime:new Date(n),snooze:new Date(i)}),!e){console.log("Random Practice: Disabled");return}if(a.length<4){console.log("Random Practice: Not enough vocabulary (needs 4+)");return}const o=Date.now();if(o<i){console.log("Random Practice: Snoozed until",new Date(i));return}let l=c*60*1e3;c===1&&(l=5e3);const d=n+l;if(o<d){console.log("Random Practice: Not due yet. Next due:",new Date(d));return}console.log("Random Practice: Conditions met, triggering..."),f(r)})}function f(r=null){const t=e=>{if(e.url&&(e.url.startsWith("chrome://")||e.url.startsWith("edge://")||e.url.startsWith("about:")||e.url.startsWith("chrome-extension://"))){console.log("Random Practice: Skipped invalid url",e.url);return}console.log("Random Practice: Triggering quiz on tab",e.id),chrome.tabs.sendMessage(e.id,{action:"triggerRandomQuiz"},c=>{if(chrome.runtime.lastError){console.log("Random Practice: Could not send message to tab (maybe no content script):",chrome.runtime.lastError.message);return}c&&c.success?(console.log("Random Practice: Successfully triggered on tab",e.id),chrome.storage.local.set({randomPracticeLastTime:Date.now()})):console.log("Random Practice: Tab responded but failed",c)})};r?chrome.tabs.get(r,e=>{chrome.runtime.lastError||!e||t(e)}):chrome.tabs.query({active:!0,currentWindow:!0},e=>{!e||e.length===0||t(e[0])})}const w=`${m}/sync`;function P(r){console.log("Syncing data to cloud:",r.headword),fetch(w,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).then(t=>{t.ok?console.log("Sync success for:",r.headword):console.log("Sync failed status:",t.status)}).catch(t=>{console.log("Sync connection error (Server likely offline):",t.message)})}chrome.runtime.onMessage.addListener((r,t,e)=>{if(r.action==="syncToCloud")return P(r.data),!1;if(r.action==="fetchDefinition"){const n=r.word.trim().toLowerCase(),i=`https://www.oxfordlearnersdictionaries.com/definition/english/${n}`,a=`https://www.oxfordlearnersdictionaries.com/search/english/?q=${encodeURIComponent(n)}`;return fetch(`${m}/entry/${encodeURIComponent(n)}`).then(o=>{if(o.ok)return o.json();throw new Error("Local not found")}).then(o=>{console.log("Found locally:",o.headword),e({success:!0,localData:o,finalUrl:"local"})}).catch(()=>{console.log(`Local lookup failed for ${n}, trying Oxford...`),fetch(i).then(o=>{if(o.ok)return o;if(o.status===404)return fetch(a);throw new Error("Network response was not ok")}).then(o=>{if(!o.ok){if(o.status===404)return fetch(`https://www.oxfordlearnersdictionaries.com/definition/english/${n}_1`);throw new Error("Network response was not ok")}return o}).then(o=>{if(!o.ok)throw new Error("Not found");return Promise.all([o.text(),o.url])}).then(([o,l])=>{e({success:!0,html:o,finalUrl:l})}).catch(o=>{console.error("Fetch error:",o),e({success:!1,error:"Definition not found"})})}),!0}});self.checkAndTriggerQuiz=s;globalThis.checkAndTriggerQuiz=s;console.log("Random Practice: Debug function checkAndTriggerQuiz exposed");

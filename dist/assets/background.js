const l="randomPracticeCheck";function u(){chrome.alarms.create(l,{periodInMinutes:1}),console.log("Random Practice: Alarm created/updated with period",1)}chrome.runtime.onInstalled.addListener(()=>{u()});chrome.runtime.onStartup.addListener(()=>{u()});chrome.tabs.onUpdated.addListener((r,o,e)=>{o.status==="complete"&&m(r)});chrome.alarms.onAlarm.addListener(r=>{r.name===l&&m()});function m(r=null){chrome.storage.local.get(["randomPracticeEnabled","randomPracticeFrequency","randomPracticeLastTime","randomPracticeSnoozeUntil","vocabulary"],o=>{const{randomPracticeEnabled:e,randomPracticeFrequency:n=60,randomPracticeLastTime:i=0,randomPracticeSnoozeUntil:t=0,vocabulary:d=[]}=o;if(!e||d.length<3)return;const a=Date.now();if(a<t){console.log("Random Practice: Snoozed until",new Date(t));return}let c=n*60*1e3;n===1&&(c=5e3);const s=i+c;if(a<s){console.log("Random Practice: Not due yet. Next due:",new Date(s));return}h(r)})}function h(r=null){const o=e=>{!e.url||e.url.startsWith("chrome://")||e.url.startsWith("edge://")||e.url.startsWith("about:")||e.url.startsWith("chrome-extension://")||(console.log("Random Practice: Triggering quiz on tab",e.id),chrome.tabs.sendMessage(e.id,{action:"triggerRandomQuiz"},n=>{if(chrome.runtime.lastError){console.log("Random Practice: Could not send message to tab (maybe no content script):",chrome.runtime.lastError.message);return}n&&n.success&&chrome.storage.local.set({randomPracticeLastTime:Date.now()})}))};r?chrome.tabs.get(r,e=>{chrome.runtime.lastError||!e||o(e)}):chrome.tabs.query({active:!0,currentWindow:!0},e=>{!e||e.length===0||o(e[0])})}chrome.runtime.onMessage.addListener((r,o,e)=>{if(r.action==="fetchDefinition"){const n=r.word.toLowerCase(),i=`https://www.oxfordlearnersdictionaries.com/definition/english/${n}`;return fetch(i).then(t=>{if(!t.ok){if(t.status===404)return fetch(`https://www.oxfordlearnersdictionaries.com/definition/english/${n}_1`);throw new Error("Network response was not ok")}return t.text()}).then(t=>{e({success:!0,html:t,finalUrl:i})}).catch(t=>{e({success:!1,error:t.message})}),!0}});

const u="randomPracticeCheck";function m(){chrome.alarms.create(u,{periodInMinutes:1}),console.log("Random Practice: Alarm created/updated with period",1)}chrome.runtime.onInstalled.addListener(()=>{m()});chrome.runtime.onStartup.addListener(()=>{m()});chrome.tabs.onUpdated.addListener((r,n,e)=>{n.status==="complete"&&i(r)});chrome.alarms.onAlarm.addListener(r=>{r.name===u&&i()});function i(r=null){chrome.storage.local.get(["randomPracticeEnabled","randomPracticeFrequency","randomPracticeLastTime","randomPracticeSnoozeUntil","vocabulary"],n=>{const{randomPracticeEnabled:e,randomPracticeFrequency:t=60,randomPracticeLastTime:c=0,randomPracticeSnoozeUntil:o=0,vocabulary:a=[]}=n;if(console.log("Random Practice Check:",{enabled:e,vocabLength:a.length,lastTime:new Date(c),snooze:new Date(o)}),!e){console.log("Random Practice: Disabled");return}if(a.length<1){console.log("Random Practice: Not enough vocabulary");return}const s=Date.now();if(s<o){console.log("Random Practice: Snoozed until",new Date(o));return}let l=t*60*1e3;t===1&&(l=5e3);const d=c+l;if(s<d){console.log("Random Practice: Not due yet. Next due:",new Date(d));return}console.log("Random Practice: Conditions met, triggering..."),g(r)})}function g(r=null){const n=e=>{if(e.url&&(e.url.startsWith("chrome://")||e.url.startsWith("edge://")||e.url.startsWith("about:")||e.url.startsWith("chrome-extension://"))){console.log("Random Practice: Skipped invalid url",e.url);return}console.log("Random Practice: Triggering quiz on tab",e.id),chrome.tabs.sendMessage(e.id,{action:"triggerRandomQuiz"},t=>{if(chrome.runtime.lastError){console.log("Random Practice: Could not send message to tab (maybe no content script):",chrome.runtime.lastError.message);return}t&&t.success?(console.log("Random Practice: Successfully triggered on tab",e.id),chrome.storage.local.set({randomPracticeLastTime:Date.now()})):console.log("Random Practice: Tab responded but failed",t)})};r?chrome.tabs.get(r,e=>{chrome.runtime.lastError||!e||n(e)}):chrome.tabs.query({active:!0,currentWindow:!0},e=>{!e||e.length===0||n(e[0])})}chrome.runtime.onMessage.addListener((r,n,e)=>{if(r.action==="fetchDefinition"){const t=r.word.toLowerCase(),c=`https://www.oxfordlearnersdictionaries.com/definition/english/${t}`;return fetch(c).then(o=>{if(!o.ok){if(o.status===404)return fetch(`https://www.oxfordlearnersdictionaries.com/definition/english/${t}_1`);throw new Error("Network response was not ok")}return o.text()}).then(o=>{e({success:!0,html:o,finalUrl:c})}).catch(o=>{e({success:!1,error:o.message})}),!0}});self.checkAndTriggerQuiz=i;globalThis.checkAndTriggerQuiz=i;console.log("Random Practice: Debug function checkAndTriggerQuiz exposed");
